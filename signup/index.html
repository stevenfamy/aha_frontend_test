<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="/js/cookies.js"></script>
    <script src="/js/check_sessions.js"></script>

    <title>Login</title>
  </head>
  <body onload="checkSessions()">
    <h2>Create your account</h2>
    <hr />
    <div>
      <h3 id="signupMessage"></h3>
      <input
        type="email"
        name="email"
        id="email"
        placeholder="Email Address"
        required
      />
      <br />
      <br />
      <input
        type="password"
        name="password"
        id="password"
        placeholder="Password"
        required
      />
      <br />
      <br />
      <input
        type="password"
        name="repassword"
        id="repassword"
        placeholder="Confirm Password"
        required
      />
      <br />
      <br />
      <input
        type="text"
        name="firstname"
        id="firstname"
        placeholder="First Name"
        required
      />
      <br />
      <br />
      <input
        type="text"
        name="lastname"
        id="lastname"
        placeholder="Last Name"
        required
      />
      <br />
      <br />
      <input
        type="button"
        value="Sign up"
        id="signup"
        name="signup"
        onclick="signup()"
      />
    </div>
    <br />
    Or

    <br />
    <br />
    <a href="/">Back to Login</a>
    <hr />

    <script>
      // login onclick action
      function signup() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const repassword = document.getElementById("repassword").value;
        const firstName = document.getElementById("firstname").value;
        const lastName = document.getElementById("lastname").value;

        if (!email || !password || !repassword || !firstName || !lastName) {
          const err = "Failed, All the field bellow is Required!";
          document.getElementById("signupMessage").innerHTML = err;
          throw new Error(err);
        }

        if (password !== repassword) {
          const err = "Failed, Password & Confirm Password did not match!";
          document.getElementById("signupMessage").innerHTML = err;
          throw new Error(err);
        }

        document.getElementById("signupMessage").innerHTML = "";
        eraseCookie("authToken");

        const url = "http://localhost:5000/signup";
        const params = {
          email: document.getElementById("email").value,
          password: document.getElementById("password").value,
          firstName: document.getElementById("firstname").value,
          lastName: document.getElementById("lastname").value,
        };
        axios
          .post(url, params)
          .then((res) => {
            if (res.status === 200)
              document.getElementById("signupMessage").innerHTML =
                "Success, Check your email for verification.";
          })
          .catch((err) => {
            if (err.response.status === 400) {
              if (err.response.data.validationFailed) {
                let errRes = "Failed, <br />";
                const validationRes = err.response.data.checkPasswordResult;
                for (const valErr of validationRes) {
                  errRes += valErr.message + " <br /> ";
                }
                document.getElementById("signupMessage").innerHTML = errRes;
              } else {
                let errRes = err.response.data.Error;

                if (!err.response.data.Email_verification) {
                  errRes +=
                    ", <a href='#'>Click here to resend email verification.</a>";
                }
                document.getElementById("signupMessage").innerHTML = errRes;
              }
            }

            if (err.response.status === 500)
              document.getElementById("signupMessage").innerHTML =
                err.response.data.error;
          });
      }
    </script>
  </body>
</html>
