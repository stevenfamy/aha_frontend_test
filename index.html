<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="/js/cookies.js"></script>
    <script src="/js/check_sessions.js"></script>
    <script src="/js/resend_email.js"></script>
    <script src="/js/oauth.js"></script>

    <title>Login</title>
  </head>
  <body onload="checkSessions()">
    <div id="fb-root"></div>

    <h2>Welcome, Please Login</h2>
    <hr />
    <div>
      <h3 id="loginMessage"></h3>
      <input type="email" name="email" id="email" placeholder="Email Address" />
      <input
        type="password"
        name="password"
        id="password"
        placeholder="Password"
        value="aaaBBB!1"
      />
      <input
        type="button"
        value="Login"
        id="doLogin"
        name="doLogin"
        onclick="doLogin()"
      />
    </div>
    <br />
    <div style="display: flex">
      <div
        id="g_id_onload"
        data-client_id="539308330581-06iitsj5jblo5rfkrkg7m14vut14m374.apps.googleusercontent.com"
        data-context="signin"
        data-ux_mode="popup"
        data-callback="doGoogleLogin"
        data-auto_prompt="false"
      ></div>

      <div
        class="g_id_signin"
        data-type="standard"
        data-shape="pill"
        data-theme="outline"
        data-text="signin_with"
        data-size="large"
        data-logo_alignment="left"
      ></div>
      <div style="margin: 5px"></div>

      <fb:login-button
        scope="public_profile,email"
        onlogin="checkLoginState();"
      >
      </fb:login-button>
    </div>
    <br />
    <br />
    Or <a href="/signup/">Sign up</a>
    <hr />
    <script>
      function statusChangeCallback(response) {
        // Called with the results from FB.getLoginStatus().
        console.log("statusChangeCallback");
        console.log(response); // The current login status of the person.
        if (response.status === "connected") {
          // Logged into your webpage and Facebook.
          testAPI();
        } else {
          // Not logged into your webpage or we are unable to tell.
          document.getElementById("status").innerHTML =
            "Please log " + "into this webpage.";
        }
      }

      (function (d, s, id) {
        var js,
          fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {
          return;
        }
        js = d.createElement(s);
        js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      })(document, "script", "facebook-jssdk");

      window.fbAsyncInit = function () {
        FB.init({
          appId: "579725630016747",
          cookie: true,
          xfbml: true,
          version: "v13.0",
        });

        FB.AppEvents.logPageView();
      };

      FB.getLoginStatus(function (response) {
        statusChangeCallback(response);
      });

      function checkLoginState() {
        FB.getLoginStatus(function (response) {
          statusChangeCallback(response);
        });
      }

      function testAPI() {
        // Testing Graph API after login.  See statusChangeCallback() for when this call is made.
        console.log("Welcome!  Fetching your information.... ");
        FB.api("/me", function (response) {
          console.log("Successful login for: " + response.name);
          console.log("Successful login for: " + response);
          document.getElementById("status").innerHTML =
            "Thanks for logging in, " + response.name + "!";
        });
      }
      // login onclick action
      function doLogin() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        if (!email || !password) {
          const err = "Failed, Email & Password is Required!";
          document.getElementById("loginMessage").innerHTML = err;
          throw new Error(err);
        }

        document.getElementById("loginMessage").innerHTML = "";
        eraseCookie("authToken");
        const url = "https://aha.stevenfamy.me:81/login";
        const params = {
          email: email,
          password: password,
        };
        axios
          .post(url, params)
          .then((res) => {
            if (res.status === 200) setCookie("authToken", res.data.authToken);

            window.location.replace("/dashboard");
          })
          .catch((err) => {
            if (err.response.status === 400) {
              let errRes = err.response.data.error;

              if (!err.response.data.Email_verification) {
                errRes +=
                  ", <a href='#' onclick='resendEmail();'>Click here to resend email verification.</a>";
              }
              document.getElementById("loginMessage").innerHTML = errRes;
            }

            if (err.response.status === 404)
              document.getElementById("loginMessage").innerHTML =
                err.response.data.error;
          });
      }
    </script>
  </body>
</html>
